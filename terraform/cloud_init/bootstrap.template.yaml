#cloud-config
output: {all: '| tee -a /var/log/cloud-init-custom.log'}
bootcmd:
  - echo "Starting boot command..."
  - mkdir -p /u01/aipoc
packages:
  - firewalld
  - git
write_files:
  - path: "/u01/aipoc/firewall.sh"
    permissions: '0755'
    content: |
      #!/bin/env bash
      systemctl stop firewalld.service
      firewall-offline-cmd --zone=public --add-port 8080/tcp
      systemctl start firewalld.service
    append: false
    defer: false
  - path: "/u01/aipoc/db.env"
    permissions: "0644"
    encoding: "gzip+base64"
    content: |
      ${oci_database_autonomous_database_connection_string}
  - path: "/u01/aipoc/wallet.zip"
    permissions: "0644"
    encoding: base64
    content: |
      ${oci_database_autonomous_database_wallet_content}
runcmd:
  - echo "Running aipoc init..."
  - sudo dd iflag=direct if=/dev/sda of=/dev/null count=1
  - echo "1" | sudo tee /sys/class/block/sda/device/rescan
  - echo "y" | sudo /usr/libexec/oci-growfs
  - /bin/bash /u01/aipoc/firewall.sh
  - cd /u01/aipoc
  - sudo wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /u01/aipoc/miniconda.sh
  - bash miniconda.sh -b -p /u01/aipoc/miniconda
  - eval "$(/u01/aipoc/miniconda/bin/conda shell.bash hook)"
  - conda init
  - git clone https://github.com/engchina/No.1-RAG.git; cd No.1-RAG
  - cp .env.example .env
  - chmod +x main.sh
  - crontab main.cron
  - conda create -n no.1-rag python=3.11 -y
  - conda activate no.1-rag
  - pip install -r requirements.txt
  - cd /u01/aipoc
  - unzip /u01/aipoc/wallet.zip -d ./wallet
  - /bin/bash /u01/aipoc/No.1-RAG/main.sh &
  - echo "Finished aipoc init."